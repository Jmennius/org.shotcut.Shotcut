app-id: org.shotcut.Shotcut
branch: stable
base: io.qt.qtwebkit.BaseApp
base-version: '5.11'
runtime: org.kde.Platform
runtime-version: '5.11'
sdk: org.kde.Sdk
command: shotcut
finish-args:
  - --require-version=0.11.4 # fixes file saving
  - --share=ipc
  - --socket=x11
  - --device=all
  - --share=network
  - --filesystem=host
  - --socket=pulseaudio
  - --env=FREI0R_PATH=/app/lib/frei0r-1
  - --env=LADSPA_PATH=/app/lib/ladspa
cleanup:
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/man
  - '*.a'
  - '*.la'
cleanup-commands: # https://github.com/flatpak/flatpak/issues/1082
  - rm -rf /app/{include,lib/{cmake,mkspecs,pkgconfig}}
modules:

  - name: eigen
    buildsystem: cmake-ninja
    builddir: true
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://bitbucket.org/eigen/eigen/get/3.3.5.tar.bz2
        sha256: 7352bff3ea299e4c7d7fbe31c504f8eb9149d7e685dec5a12fbaa26379f603e2
  
  - name: fftw
    config-opts:
      - --disable-doc
      - --enable-shared
      - --disable-static
      - --enable-threads
    build-options:
      arch:
        i386:
          config-opts:
            - --enable-avx
            - --enable-openmp
            - --enable-sse2
        x86_64:
          config-opts:
            - --enable-avx
            - --enable-openmp
            - --enable-sse2
    cleanup:
      - /bin
    sources:
      - type: archive
        url: http://www.fftw.org/fftw-3.3.8.tar.gz
        sha256: 6113262f6e92c5bd474f2875fa1b01054c4ad5040f6b0da7c03c98821d9ae303

  - name: fftw-float
    config-opts:
      - --disable-doc
      - --enable-shared
      - --disable-static
      - --enable-threads
      - --enable-float
    build-options:
      arch:
        i386:
          config-opts:
            - --enable-avx
            - --enable-openmp
            - --enable-sse
        x86_64:
          config-opts:
            - --enable-avx
            - --enable-openmp
            - --enable-sse
    cleanup:
      - /bin
    sources:
      - type: archive
        url: http://www.fftw.org/fftw-3.3.8.tar.gz
        sha256: 6113262f6e92c5bd474f2875fa1b01054c4ad5040f6b0da7c03c98821d9ae303
  
  - name: movit
    make-args:
      - libmovit.la
    sources:
      - type: git
        url: https://github.com/ddennedy/movit.git
        commit: 3e8b4ebb796bcbe7e9727a2d7f2d0ba8f0170dfa
  
  - name: libsamplerate
    rm-configure: true
    config-opts:
      - --disable-static
    cleanup:
      - /bin
      - /share/doc
    sources:
      - type: archive
        url: http://www.mega-nerd.com/SRC/libsamplerate-0.1.9.tar.gz
        sha256: 0a7eb168e2f21353fb6d84da152e4512126f7dc48ccb0be80578c565413444c1
        mirror-urls:
          - http://http.debian.net/debian/pool/main/libs/libsamplerate/libsamplerate_0.1.9.orig.tar.gz
      - type: script
        dest-filename: autogen.sh
        commands:
          - autoreconf -vfi
  
  - name: sox
    config-opts:
      - --disable-static
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/project/sox/sox/14.4.2/sox-14.4.2.tar.bz2
        sha256: 81a6956d4330e75b5827316e44ae381e6f1e8928003c6aa45896da9041ea149c
        mirror-urls:
          - http://http.debian.net/debian/pool/main/s/sox/sox_14.4.2.orig.tar.bz2

  - name: vidstab
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://github.com/georgmartius/vid.stab/archive/v1.1.0.tar.gz
        sha256: 14d2a053e56edad4f397be0cb3ef8eb1ec3150404ce99a426c4eb641861dc0bb
  
  - name: frei0r-plugins
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    sources:
      - type: archive
        url: https://files.dyne.org/frei0r/frei0r-plugins-1.6.1.tar.gz
        sha256: e0c24630961195d9bd65aa8d43732469e8248e8918faa942cfb881769d11515e
  
  - name: swh-plugins
    sources:
      - type: archive
        url: https://github.com/swh/ladspa/archive/v0.4.17.tar.gz
        sha256: d1b090feec4c5e8f9605334b47faaad72db7cc18fe91d792b9161a9e3b821ce7
  
  - name: ladspa-sdk
    no-autogen: true
    subdir: src
    make-install-args:
      - INSTALL_PLUGINS_DIR=/app/lib/ladspa
      - INSTALL_INCLUDE_DIR=/app/include
      - INSTALL_BINARY_DIR=/app/bin
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://www.ladspa.org/download/ladspa_sdk_1.13.tgz
        sha256: b5ed3f4f253a0f6c1b7a1f4b8cf62376ca9f51d999650dd822650c43852d306b
    
  - name: jack2
    buildsystem: simple
    build-commands:
      - ./waf configure --prefix=/app --htmldir=/app/share/doc/jack/ --freebob=no --classic
      - ./waf build -j $FLATPAK_BUILDER_N_JOBS
      - ./waf install
    cleanup:
      - /bin
      - /share
      - /lib/jack
      - /lib/libjackserver.so*
    sources:
      - type: archive
        url: https://github.com/jackaudio/jack2/releases/download/v1.9.12/jack2-1.9.12.tar.gz
        sha256: deefe2f936dc32f59ad3cef7e37276c2035ef8a024ca92118f35c9a292272e33

  - name: nv-codec-headers
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    cleanup:
      - '*'
    sources:
      - type: git
        url: https://git.videolan.org/git/ffmpeg/nv-codec-headers.git
        commit: cb6eaa41ab40637c5b2912027e35e05a4ba32a69
        tag: n8.2.15.6

  - name: nasm # TODO: remove with 5.12 runtime
    cleanup:
      - '*'
    sources:
      - type: archive
        url: https://www.nasm.us/pub/nasm/releasebuilds/2.14.02/nasm-2.14.02.tar.xz
        sha256: e24ade3e928f7253aa8c14aa44726d1edf3f98643f87c9d72ec1df44b26be8f5

  - name: 'x264'
    config-opts:
      - --disable-cli
      - --enable-shared
    sources:
      - type: archive
        url: https://download.videolan.org/x264/snapshots/x264-snapshot-20180807-2245-stable.tar.bz2
        sha256: 1439f1a054c87965089b646e77d16e1a8bf2f9687e4dd696ac518e44c7644c2a

  - name: 'x265'
    buildsystem: cmake-ninja
    builddir: true
    subdir: source
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://bitbucket.org/multicoreware/x265/downloads/x265_2.9.tar.gz
        sha256: ebae687c84a39f54b995417c52a2fdde65a4e2e7ebac5730d251471304b91024

  - name: ffmpeg
    config-opts:
      - --enable-gpl
      - --disable-static
      - --enable-shared
      - --disable-doc
      - --disable-alsa
      - --enable-libfontconfig
      - --enable-libfreetype
      - --enable-libopus
      - --enable-libpulse
      - --enable-librsvg
      - --enable-libvpx
      - --enable-libxml2
      - --enable-libx264
      - --enable-libx265
    cleanup:
      - /share/ffmpeg/examples
    sources:
      - type: archive
        url: https://ffmpeg.org/releases/ffmpeg-4.0.3.tar.xz
        sha256: 253c37e3f1d3626a2566e496554de9a4c29050753660835909a466d66b12e2ed

  - name: mlt
    config-opts:
      - --enable-gpl
      - --enable-gpl3
      - --disable-gtk2
    sources:
      - type: git
        url: https://github.com/mltframework/mlt.git
        commit: fafaa42e72cee6efb093d959829c756d52e067db

  - name: webvfx
    buildsystem: qmake
    builddir: true
    build-options:
      env:
        QMAKEPATH: /app/lib
    config-opts:
      - CONFIG+=release
      - CONFIG+=force_debug_info
    cleanup:
      - /bin/webvfx*
    sources:
      - type: archive
        dest-filename: webvfx.tar.xz
        url: https://github.com/mltframework/webvfx/releases/download/1.0.0/webvfx-1.0.0.txz
        sha256: edd972992b5b558a313d89a6c4650058b5e4701a3e1c5100a74caef376ef9f9d

  - name: shotcut
    buildsystem: qmake
    builddir: true
    build-options:
      env:
        QMAKEPATH: /app/lib
    config-opts:
      - CONFIG+=release
      - CONFIG+=force_debug_info
      - SHOTCUT_VERSION=18.12.23
    post-install:
      - sed -i '3i <releases><release version=\"18.12.23\" date=\"2018-12-23\"/></releases>'
        /app/share/metainfo/org.shotcut.Shotcut.appdata.xml
    sources:
      - type: archive
        url: https://github.com/mltframework/shotcut/archive/v18.12.23.tar.gz
        sha256: e89747fb4e115ed7b2435e8a6f5dd1ce7d50d276944e199298e0ed21d75b7a87
